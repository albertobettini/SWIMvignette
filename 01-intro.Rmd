

# Introduction

The SWIM package is an efficient sensitivty analysis tool for stochastic models developped in @Pesenti2019. It provides a stressed version of a stochastic model, subject to model components (random variables) fulfilling given probabilistic constraints (stresses). Possible constraints include stressing moments, propability intervals and risk measures such as the Value-at-Risk and the Expected Shortfall. Provided with simulated scenarios from a stochastic model, the SWIM package returns scenario weights under which the stochastic model satisfies the stress and minimises the relative entropy with respect to the baseline model. 


## An example

``` {r, cache = TRUE, include = FALSE}
set.seed(0)
SD <- c(70, 45, 50, 60, 75)
corr_val <- 0.15
Corr <- matrix(rep(corr_val, 5^2), nrow = 5) + diag(rep(1 - corr_val, 5))

if (!requireNamespace("mvtnorm", quietly = TRUE))
   stop("Package \"mvtnorm\" needed for this function 
   to work. Please install it.")
   
x <- mvtnorm::rmvnorm(10^5, 
   mean =  rep(100, 5), 
   sigma = (SD %*% t(SD)) * Corr)
data <- data.frame(rowSums(x), x)
names(data) <- c("Y", "X1", "X2", "X3", "X4", "X5")
```


Consider a portfolio $Y = \sum_{i = 1}^5 X_i$, consisting of five lines of business (LoB's) $X_1, \ldots, X_5$ that are positively correlated and normally distributed with mean equal to `r round(colMeans(data)[3],0)` and standard deviations `r SD`, respectively. Adopting the convention that positive realisations represent losses, a risk manager might be interested in the scenario, in which the mean of the first two LoB's, $X_1$ and $X_2$, increases by $5\%$.

### Stressing the portfolio {#intro-ex-stress}
The stressed porfolio, satisfying simulatneously a $5\%$ increse of the mean of $X_1$ and $X_2$, is obtained via the `stress()` function. The function `stress()` applies for different stresses, see Section \@ref(Rfunctions) for details, thus, for stressing the mean, `type = "mean"` needs to be supplied. The parameter `x` corresponds to the data.frame containting simulated values of the portfolio, $(Y, X_1, X_2, X_3, X_4, X_5)$, which, in this example, consists of a set of $10^5$ simulations. Further, the component of the dataframe, `x`, that is stressed (parameter `k`) as well as the stressed values of the means (parameter `new_means`) has to be provided. 


The subsequent table summarises each component of the baseline as well as the stressed model. We observe that the stress on $X_1$ and $X_2$ result in a $3\%$ increase in the mean of the aggregated portfolio. Figure \@ref(fig:working-example-mean) displays the distribution functions of the original (baseline) and stressed LoB $X_1$ (left) and $X_2$ (right).


``` {r, working-example-mean, cache = TRUE, fig.show='hold', out.width = '50%', fig.cap = "Baseline and stressed empirical distribution functions of input factors $X_1$ (left) and $X_2$ (right)."}
res_mean <- SWIM::stress(type = "mean", x = data, k = c(2, 3), new_means = c(105, 105))
SWIM::plot_cdf(res_mean, xCol = "X1", base = TRUE)
SWIM::plot_cdf(res_mean, xCol = "X2", base = TRUE)
summary(res_mean, base = TRUE)
```


Another stressed portfolio, relevant for risk management, stems from a stress to the tail of the portfolio loss $Y$, via, for example, an increasing in the Value-at-Risk ($\text{VaR}$). The $\text{VaR}$ at level $0 < \alpha < 1$ of a random variable $Z$ with distribution function $F_Z$, is defined by $$\text{VaR}_\alpha(Z) = F_Z^{-1}(\alpha) = \inf \{z \in \mathbb{R} ~|~F_Z(y) \geq z \}.$$ Figure \@ref(fig:working-example-var) display the histogram (left) and the empirical distribution function (right) of the baseline and the stressed output, stemming from a $5\%$ increase of $\text{VaR}_{0.95}(Y)$.

``` {r, working-example-var, cache = TRUE, fig.show='hold', out.width = '50%', fig.cap = "Histogram (left) and empirical distribution function (right) of the baseline and stressed output $Y$."}
res_var <- SWIM::stress(type = "VaR", x = data, alpha = 0.95, q_ratio = 1.05) 
SWIM::plot_hist(res_var, xCol = "Y", base = TRUE)
SWIM::plot_cdf(res_var, xCol = "Y", base = TRUE)
```


### The scenario weights
In this section we compare the scenario weights of the two stressed models of Section \@ref(intro-ex-stress), that is $i)$ a $5\%$ increase in the means of $X_1$ and $X_2$ and $ii)$ a $5\%$ increase in the $\text{VaR}_{0.95}$ of $Y$. Secario weights of a stressed model can easily be extracted via `get_weights()`. Figure \@ref(fig:working-example-weights-var) displays the scenario weights of the stressed models $i)$ (green) and of $ii)$ (blue) against the aggregated portfolio $Y$. Stressing the tail of $Y$, stressed model $i)$, results in scenario weights comonotonic to $Y$, inflating large realisations of the aggregated portfolio. Stressing the mean of portfolio components, stressed model $ii)$, however, provides scenario weights that distort the body of the distribution of the aggregate portfolio. 

``` {r, working-example-weights-var, cache = TRUE,fig.cap = "The scenario weights for the stressed models $i)$ a 5% increase in the means of $X_1$ and $X_2$ (green) and $ii)$ a 5% increase in the VaR of $Y$ (blue) against the output $Y$."}

plot(data[,"Y"], SWIM::get_weights(res_var), cex = 0.4, col = "darkblue", xlab = "Y", ylab = "")
points(data[,"Y"], SWIM::get_weights(res_mean), cex = 0.2, col = "darkgreen")
```

Figure \@ref(fig:working-example-weights-mean) displays the scenario weight of the stressed model $ii)$ against the portolio component $X_1$ (left) and $X_2$ (right). 



``` {r, working-example-weights-mean, cache = TRUE, fig.show='hold', out.width = '50%', fig.cap = "The scenario weights for the stress on the means of $X_1$ and $X_2$ against $X_1$ (left) and $X_2$ (right).", echo = FALSE}

plot(data[,"X1"], SWIM::get_weights(res_mean), cex = 0.2, col = "darkblue", xlab = "X1", ylab = "")
plot(data[,"X2"], SWIM::get_weights(res_mean), cex = 0.2, col = "darkgreen", xlab = "X2", ylab = "")
```
